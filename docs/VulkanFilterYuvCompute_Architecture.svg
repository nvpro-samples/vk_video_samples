<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 900" width="1200" height="900">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
    <linearGradient id="inputGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#4CAF50"/>
      <stop offset="100%" style="stop-color:#2E7D32"/>
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#2196F3"/>
      <stop offset="100%" style="stop-color:#1565C0"/>
    </linearGradient>
    <linearGradient id="outputGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#FF9800"/>
      <stop offset="100%" style="stop-color:#E65100"/>
    </linearGradient>
  </defs>
  
  <!-- Title -->
  <text x="600" y="40" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#333">
    VulkanFilterYuvCompute Flexible I/O Architecture
  </text>
  
  <!-- Main container -->
  <rect x="50" y="70" width="1100" height="800" rx="10" fill="#f5f5f5" stroke="#ddd" stroke-width="2"/>
  
  <!-- Input Section -->
  <g transform="translate(70, 100)">
    <rect x="0" y="0" width="300" height="350" rx="8" fill="url(#inputGrad)" opacity="0.1" stroke="#4CAF50" stroke-width="2"/>
    <text x="150" y="30" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#2E7D32">INPUT SLOTS</text>
    
    <!-- Input 0 -->
    <g transform="translate(20, 50)">
      <rect x="0" y="0" width="260" height="80" rx="5" fill="#E8F5E9" stroke="#4CAF50"/>
      <text x="130" y="20" font-family="monospace" font-size="12" text-anchor="middle" fill="#333">input0 (index=0)</text>
      <text x="10" y="40" font-family="Arial" font-size="10" fill="#666">Type: Image | Buffer | SampledImage</text>
      <text x="10" y="55" font-family="Arial" font-size="10" fill="#666">Format: RGBA8 | NV12 | P010 | ...</text>
      <text x="10" y="70" font-family="Arial" font-size="10" fill="#666">Bindings: 0-3 (up to 4 planes)</text>
    </g>
    
    <!-- Input 1 -->
    <g transform="translate(20, 140)">
      <rect x="0" y="0" width="260" height="80" rx="5" fill="#E8F5E9" stroke="#4CAF50" stroke-dasharray="5,3"/>
      <text x="130" y="20" font-family="monospace" font-size="12" text-anchor="middle" fill="#333">input1 (index=1) [optional]</text>
      <text x="10" y="40" font-family="Arial" font-size="10" fill="#666">Type: Image | Buffer</text>
      <text x="10" y="55" font-family="Arial" font-size="10" fill="#666">Format: Previous frame, reference, etc.</text>
      <text x="10" y="70" font-family="Arial" font-size="10" fill="#666">Bindings: 4-7</text>
    </g>
    
    <!-- Input N -->
    <g transform="translate(20, 230)">
      <text x="130" y="20" font-family="Arial" font-size="14" text-anchor="middle" fill="#666">...</text>
      <rect x="0" y="30" width="260" height="60" rx="5" fill="#E8F5E9" stroke="#4CAF50" stroke-dasharray="5,3"/>
      <text x="130" y="55" font-family="monospace" font-size="12" text-anchor="middle" fill="#333">inputN (index=N)</text>
      <text x="10" y="75" font-family="Arial" font-size="10" fill="#666">Bindings: computed dynamically</text>
    </g>
  </g>
  
  <!-- Processing Section -->
  <g transform="translate(420, 100)">
    <rect x="0" y="0" width="320" height="350" rx="8" fill="url(#processGrad)" opacity="0.1" stroke="#2196F3" stroke-width="2"/>
    <text x="160" y="30" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#1565C0">PROCESSING PIPELINE</text>
    
    <!-- Stage 1: Normalize -->
    <g transform="translate(20, 50)">
      <rect x="0" y="0" width="280" height="70" rx="5" fill="#E3F2FD" stroke="#2196F3"/>
      <text x="140" y="20" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#1565C0">Stage 1: INPUT</text>
      <text x="10" y="40" font-family="Arial" font-size="11" fill="#333">• Fetch from image/buffer</text>
      <text x="10" y="55" font-family="Arial" font-size="11" fill="#333">• Normalize to [0.0, 1.0] → vec4</text>
    </g>
    
    <!-- Stage 2: Process -->
    <g transform="translate(20, 140)">
      <rect x="0" y="0" width="280" height="90" rx="5" fill="#BBDEFB" stroke="#2196F3"/>
      <text x="140" y="20" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#1565C0">Stage 2: FILTER</text>
      <text x="10" y="40" font-family="Arial" font-size="11" fill="#333">• Color space conversion (RGB↔YCbCr)</text>
      <text x="10" y="55" font-family="Arial" font-size="11" fill="#333">• Chroma subsampling (4:2:0, 4:2:2, 4:4:4)</text>
      <text x="10" y="70" font-family="Arial" font-size="11" fill="#333">• All in normalized [0.0, 1.0] space</text>
    </g>
    
    <!-- Stage 3: Output -->
    <g transform="translate(20, 250)">
      <rect x="0" y="0" width="280" height="70" rx="5" fill="#E3F2FD" stroke="#2196F3"/>
      <text x="140" y="20" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#1565C0">Stage 3: OUTPUT</text>
      <text x="10" y="40" font-family="Arial" font-size="11" fill="#333">• Denormalize from [0.0, 1.0]</text>
      <text x="10" y="55" font-family="Arial" font-size="11" fill="#333">• Pack to target format/layout</text>
    </g>
  </g>
  
  <!-- Output Section -->
  <g transform="translate(790, 100)">
    <rect x="0" y="0" width="340" height="350" rx="8" fill="url(#outputGrad)" opacity="0.1" stroke="#FF9800" stroke-width="2"/>
    <text x="170" y="30" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#E65100">OUTPUT SLOTS</text>
    
    <!-- Output 0: Primary -->
    <g transform="translate(20, 50)">
      <rect x="0" y="0" width="300" height="80" rx="5" fill="#FFF3E0" stroke="#FF9800"/>
      <text x="150" y="20" font-family="monospace" font-size="12" text-anchor="middle" fill="#333">output0 (Primary - Encoder)</text>
      <text x="10" y="40" font-family="Arial" font-size="10" fill="#666">Type: Image (Optimal) | Buffer</text>
      <text x="10" y="55" font-family="Arial" font-size="10" fill="#666">Format: NV12 | P010 | I420 | ...</text>
      <text x="10" y="70" font-family="Arial" font-size="10" fill="#666">Subsample: MatchChroma</text>
    </g>
    
    <!-- Output 1: Linear -->
    <g transform="translate(20, 140)">
      <rect x="0" y="0" width="300" height="80" rx="5" fill="#FFF3E0" stroke="#FF9800" stroke-dasharray="5,3"/>
      <text x="150" y="20" font-family="monospace" font-size="12" text-anchor="middle" fill="#333">output1 (Linear - Dumper)</text>
      <text x="10" y="40" font-family="Arial" font-size="10" fill="#666">Type: Image (Linear) | Buffer</text>
      <text x="10" y="55" font-family="Arial" font-size="10" fill="#666">Format: Same as output0</text>
      <text x="10" y="70" font-family="Arial" font-size="10" fill="#666">Subsample: MatchChroma</text>
    </g>
    
    <!-- Output 2: Subsampled -->
    <g transform="translate(20, 230)">
      <rect x="0" y="0" width="300" height="80" rx="5" fill="#FFE0B2" stroke="#E65100"/>
      <text x="150" y="20" font-family="monospace" font-size="12" text-anchor="middle" fill="#333">output2 (2x2 Subsampled Y - AQ)</text>
      <text x="10" y="40" font-family="Arial" font-size="10" fill="#666">Type: Image (Y-plane only)</text>
      <text x="10" y="55" font-family="Arial" font-size="10" fill="#666">Format: R8 | R16</text>
      <text x="10" y="70" font-family="Arial" font-size="10" fill="#E65100" font-weight="bold">Subsample: Fixed2x2 (always 2x2)</text>
    </g>
  </g>
  
  <!-- Arrows -->
  <line x1="370" y1="275" x2="420" y2="275" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <line x1="740" y1="275" x2="790" y2="275" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Binding Layout Section -->
  <g transform="translate(70, 480)">
    <rect x="0" y="0" width="1060" height="180" rx="8" fill="#fff" stroke="#9E9E9E" stroke-width="2"/>
    <text x="530" y="25" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#333">Dynamic Binding Layout (Example: 1 Input, 3 Outputs)</text>
    
    <!-- Binding boxes -->
    <g transform="translate(20, 45)">
      <!-- Input bindings -->
      <rect x="0" y="0" width="200" height="50" rx="3" fill="#E8F5E9" stroke="#4CAF50"/>
      <text x="100" y="20" font-family="monospace" font-size="11" text-anchor="middle" fill="#333">Bindings 0-3</text>
      <text x="100" y="38" font-family="Arial" font-size="10" text-anchor="middle" fill="#666">input0 (RGBA/YCbCr)</text>
      
      <!-- Output 0 bindings -->
      <rect x="220" y="0" width="200" height="50" rx="3" fill="#FFF3E0" stroke="#FF9800"/>
      <text x="320" y="20" font-family="monospace" font-size="11" text-anchor="middle" fill="#333">Bindings 4-7</text>
      <text x="320" y="38" font-family="Arial" font-size="10" text-anchor="middle" fill="#666">output0 (YCbCr optimal)</text>
      
      <!-- Output 1 bindings -->
      <rect x="440" y="0" width="200" height="50" rx="3" fill="#FFF3E0" stroke="#FF9800"/>
      <text x="540" y="20" font-family="monospace" font-size="11" text-anchor="middle" fill="#333">Bindings 8-11</text>
      <text x="540" y="38" font-family="Arial" font-size="10" text-anchor="middle" fill="#666">output1 (YCbCr linear)</text>
      
      <!-- Output 2 bindings -->
      <rect x="660" y="0" width="120" height="50" rx="3" fill="#FFE0B2" stroke="#E65100"/>
      <text x="720" y="20" font-family="monospace" font-size="11" text-anchor="middle" fill="#333">Binding 12</text>
      <text x="720" y="38" font-family="Arial" font-size="10" text-anchor="middle" fill="#666">output2 (2x2 Y)</text>
      
      <!-- Uniform buffer -->
      <rect x="800" y="0" width="120" height="50" rx="3" fill="#E1BEE7" stroke="#9C27B0"/>
      <text x="860" y="20" font-family="monospace" font-size="11" text-anchor="middle" fill="#333">Binding 13</text>
      <text x="860" y="38" font-family="Arial" font-size="10" text-anchor="middle" fill="#666">Uniform Buffer</text>
    </g>
    
    <!-- Shader naming example -->
    <g transform="translate(20, 110)">
      <text x="0" y="15" font-family="Arial" font-size="12" font-weight="bold" fill="#333">Indexed Shader Variable Naming:</text>
      <text x="0" y="35" font-family="monospace" font-size="10" fill="#4CAF50">layout(binding=0) uniform sampler2D input0_rgba;</text>
      <text x="0" y="50" font-family="monospace" font-size="10" fill="#FF9800">layout(binding=4) writeonly image2DArray output0_Y;</text>
      <text x="400" y="35" font-family="monospace" font-size="10" fill="#FF9800">layout(binding=8) writeonly image2DArray output1_Y;</text>
      <text x="400" y="50" font-family="monospace" font-size="10" fill="#E65100">layout(binding=12) writeonly image2DArray output2_Y;</text>
    </g>
  </g>
  
  <!-- Subsampled Output Note -->
  <g transform="translate(70, 680)">
    <rect x="0" y="0" width="1060" height="170" rx="8" fill="#FFEBEE" stroke="#F44336" stroke-width="2"/>
    <text x="530" y="25" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#C62828">⚠️ Subsampled Output Dispatch Handling (Bug Fix)</text>
    
    <g transform="translate(20, 45)">
      <text x="0" y="15" font-family="Arial" font-size="12" font-weight="bold" fill="#333">Problem:</text>
      <text x="0" y="35" font-family="Arial" font-size="11" fill="#333">Commit fe9187b changed dispatch to match output chroma (e.g., half for 4:2:0).</text>
      <text x="0" y="50" font-family="Arial" font-size="11" fill="#333">But 2x2 subsampled Y output is ALWAYS 2x2, even when primary output is 4:4:4.</text>
      
      <text x="530" y="15" font-family="Arial" font-size="12" font-weight="bold" fill="#333">Solution:</text>
      <text x="530" y="35" font-family="Arial" font-size="11" fill="#333">Each output declares SubsampleMode: None | Fixed2x2 | MatchChroma</text>
      <text x="530" y="50" font-family="Arial" font-size="11" fill="#333">Shader generates per-output processing loops based on mode.</text>
    </g>
    
    <g transform="translate(20, 100)">
      <rect x="0" y="0" width="500" height="55" rx="3" fill="#fff" stroke="#F44336"/>
      <text x="10" y="18" font-family="monospace" font-size="10" fill="#333">// For Fixed2x2 output when dispatch is 4:4:4:</text>
      <text x="10" y="32" font-family="monospace" font-size="10" fill="#333">if ((chromaPos.x % 2 == 1) &amp;&amp; (chromaPos.y % 2 == 1)) {</text>
      <text x="10" y="46" font-family="monospace" font-size="10" fill="#333">    imageStore(output2_Y, chromaPos / 2, avg(Y00, Y01, Y10, Y11));</text>
    </g>
  </g>
  
  <!-- Legend -->
  <g transform="translate(950, 75)">
    <rect x="0" y="0" width="180" height="80" rx="5" fill="#fff" stroke="#ddd"/>
    <text x="90" y="18" font-family="Arial" font-size="11" font-weight="bold" text-anchor="middle" fill="#333">Legend</text>
    <rect x="10" y="28" width="20" height="12" fill="#E8F5E9" stroke="#4CAF50"/>
    <text x="40" y="38" font-family="Arial" font-size="10" fill="#333">Input Slot</text>
    <rect x="10" y="45" width="20" height="12" fill="#FFF3E0" stroke="#FF9800"/>
    <text x="40" y="55" font-family="Arial" font-size="10" fill="#333">Output Slot</text>
    <rect x="10" y="62" width="20" height="12" fill="#FFE0B2" stroke="#E65100"/>
    <text x="40" y="72" font-family="Arial" font-size="10" fill="#333">Fixed 2x2 Subsample</text>
  </g>
</svg>
